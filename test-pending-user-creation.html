<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Pending User Creation</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        button {
            background: #4285f4;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }

        button:hover {
            background: #3367d6;
        }

        .output {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
        }

        .error {
            color: red;
        }

        .success {
            color: green;
        }
    </style>
</head>

<body>
    <h1>Test Pending User Creation</h1>

    <div class="section">
        <h2>Test Actions</h2>
        <button onclick="testPendingUserCreation()">Test Create Pending User</button>
        <button onclick="checkPendingUsers()">Check Existing Pending Users</button>
        <button onclick="testGoogleSignIn()">Test Full Google Sign-In Flow</button>
    </div>

    <div class="section">
        <h2>Output</h2>
        <div id="output" class="output">Click a button to start testing...</div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, GoogleAuthProvider, signInWithRedirect, getRedirectResult, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, getDocs, query, where } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDy4jBqxKpD_B6SGAqRLyTrmGxQ9rEA0zw",
            authDomain: "officeofmapp.firebaseapp.com",
            projectId: "officeofmapp",
            storageBucket: "officeofmapp.firebasestorage.app",
            messagingSenderId: "710263745328",
            appId: "1:710263745328:web:a41ed7f9f6df52970db6f5"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        function log(message, type = 'info') {
            const output = document.getElementById('output');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : '';
            output.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            output.scrollTop = output.scrollHeight;
            console.log(message);
        }

        window.testPendingUserCreation = async function () {
            log('=== Testing Pending User Creation ===');

            try {
                const testPendingUser = {
                    email: `test-${Date.now()}@gmail.com`,
                    name: 'Test Google User',
                    role: 'staff',
                    requestedAt: new Date(),
                    status: 'pending',
                    authProvider: 'google'
                };

                log('Creating test pending user...');
                log(JSON.stringify(testPendingUser, null, 2));

                const docRef = await addDoc(collection(db, 'pending_users'), testPendingUser);
                log(`‚úÖ Pending user created successfully with ID: ${docRef.id}`, 'success');

            } catch (error) {
                log(`‚ùå Failed to create pending user: ${error.message}`, 'error');
                log(`Error code: ${error.code}`);

                if (error.code === 'permission-denied') {
                    log('This indicates a Firestore rules issue', 'error');
                } else if (error.code === 'invalid-argument') {
                    log('This indicates invalid data format', 'error');
                }
            }
        };

        window.checkPendingUsers = async function () {
            log('=== Checking Existing Pending Users ===');

            try {
                const q = query(
                    collection(db, 'pending_users'),
                    where('authProvider', '==', 'google')
                );
                const snapshot = await getDocs(q);

                log(`Found ${snapshot.size} pending Google users:`);
                snapshot.forEach(doc => {
                    const data = doc.data();
                    log(`- ${data.email}: ${data.name} (${data.status})`);
                    log(`  ID: ${doc.id}`);
                    log(`  Requested: ${data.requestedAt?.toDate?.() || data.requestedAt}`);
                });

                if (snapshot.size === 0) {
                    log('No pending Google users found. This could mean:');
                    log('- No one has requested Google Sign-In approval');
                    log('- Pending user creation is failing');
                    log('- Users are being approved immediately');
                }

            } catch (error) {
                log(`‚ùå Failed to check pending users: ${error.message}`, 'error');
            }
        };

        window.testGoogleSignIn = async function () {
            log('=== Testing Full Google Sign-In Flow ===');

            try {
                const provider = new GoogleAuthProvider();
                provider.addScope('email');
                provider.addScope('profile');

                log('Starting Google Sign-In redirect...');
                await signInWithRedirect(auth, provider);

            } catch (error) {
                log(`‚ùå Google Sign-In failed: ${error.message}`, 'error');
            }
        };

        // Check for redirect result on page load
        window.addEventListener('load', async () => {
            try {
                const result = await getRedirectResult(auth);
                if (result) {
                    log(`üéâ Google Sign-In redirect result: ${result.user.email}`, 'success');
                    log(`User UID: ${result.user.uid}`);
                    log(`Display Name: ${result.user.displayName}`);

                    // This is where the app should create a pending user
                    log('Now the app should create a pending user request...');
                }
            } catch (error) {
                log(`‚ùå Redirect result error: ${error.message}`, 'error');
            }
        });
    </script>
</body>

</html>