<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Google Sign-In Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        button {
            background: #4285f4;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }

        button:hover {
            background: #3367d6;
        }

        .output {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
        }

        .error {
            color: red;
        }

        .success {
            color: green;
        }

        .warning {
            color: orange;
        }
    </style>
</head>

<body>
    <h1>Live Google Sign-In Test</h1>

    <div class="section">
        <h2>Current Status</h2>
        <div id="status">Loading...</div>
    </div>

    <div class="section">
        <h2>Actions</h2>
        <button onclick="checkDatabaseState()">Check Database</button>
        <button onclick="testGoogleSignIn()">Test Google Sign-In</button>
        <button onclick="clearAuth()">Sign Out</button>
        <button onclick="manualApprove()">Manual Approve Test User</button>
    </div>

    <div class="section">
        <h2>Live Log</h2>
        <div id="log" class="output">Starting test...</div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signOut, GoogleAuthProvider, signInWithPopup, signInWithRedirect, getRedirectResult, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, getDocs, doc, getDoc, setDoc, deleteDoc, query, where } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDy4jBqxKpD_B6SGAqRLyTrmGxQ9rEA0zw",
            authDomain: "officeofmapp.firebaseapp.com",
            projectId: "officeofmapp",
            storageBucket: "officeofmapp.firebasestorage.app",
            messagingSenderId: "710263745328",
            appId: "1:710263745328:web:a41ed7f9f6df52970db6f5"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
            statusDiv.innerHTML = `<div class="${className}">${message}</div>`;
        }

        // Monitor auth state changes
        onAuthStateChanged(auth, (user) => {
            if (user) {
                updateStatus(`Signed in as: ${user.email} (${user.uid})`, 'success');
                log(`Auth state changed: User signed in - ${user.email}`, 'success');
            } else {
                updateStatus('Not signed in');
                log('Auth state changed: User signed out');
            }
        });

        window.checkDatabaseState = async function () {
            log('=== Checking Database State ===');

            try {
                const testEmail = 'kingdavid28a@gmail.com';

                // Check approved Google users
                const approvedDoc = await getDoc(doc(db, 'approved_google_users', testEmail));
                if (approvedDoc.exists()) {
                    log(`âœ… ${testEmail} found in approved_google_users:`, 'success');
                    log(JSON.stringify(approvedDoc.data(), null, 2));
                } else {
                    log(`âŒ ${testEmail} NOT found in approved_google_users`, 'error');
                }

                // Check user profiles
                const userQuery = query(collection(db, 'users'), where('email', '==', testEmail));
                const userSnapshot = await getDocs(userQuery);

                if (!userSnapshot.empty) {
                    log(`âœ… ${testEmail} has user profile:`, 'success');
                    userSnapshot.forEach(doc => {
                        log(`Profile ID: ${doc.id}`);
                        log(JSON.stringify(doc.data(), null, 2));
                    });
                } else {
                    log(`âŒ ${testEmail} has NO user profile`, 'error');
                }

                // Check all approved users
                const allApprovedSnapshot = await getDocs(collection(db, 'approved_google_users'));
                log(`Total approved Google users: ${allApprovedSnapshot.size}`);

            } catch (error) {
                log(`Database check failed: ${error.message}`, 'error');
            }
        };

        window.testGoogleSignIn = async function () {
            log('=== Testing Google Sign-In ===');

            try {
                const provider = new GoogleAuthProvider();
                provider.addScope('email');
                provider.addScope('profile');

                log('Starting Google Sign-In (using redirect for development)...');

                // Use redirect method (like the app does in development)
                await signInWithRedirect(auth, provider);
                log('Redirect initiated... (page will reload)', 'warning');

            } catch (error) {
                log(`Google Sign-In failed: ${error.message}`, 'error');
                log(`Error code: ${error.code}`);
            }
        };

        window.clearAuth = async function () {
            try {
                await signOut(auth);
                log('Signed out successfully', 'success');
            } catch (error) {
                log(`Sign out failed: ${error.message}`, 'error');
            }
        };

        window.manualApprove = async function () {
            log('=== Manually Approving Test User ===');

            const currentUser = auth.currentUser;
            if (!currentUser) {
                log('âŒ You must be signed in as admin to approve users', 'error');
                return;
            }

            try {
                const testEmail = 'kingdavid28a@gmail.com';
                const profile = {
                    uid: `google_${testEmail.replace(/[^a-zA-Z0-9]/g, '_')}`,
                    email: testEmail,
                    role: 'staff',
                    name: 'King David Test',
                    createdAt: new Date(),
                    lastLogin: new Date(),
                    approvedBy: currentUser.uid,
                    approvedAt: new Date()
                };

                await setDoc(doc(db, 'approved_google_users', testEmail), profile);
                log('âœ… Test user approved successfully', 'success');
                log(JSON.stringify(profile, null, 2));

            } catch (error) {
                log(`Manual approval failed: ${error.message}`, 'error');
            }
        };

        // Check for redirect result on page load
        window.addEventListener('load', async () => {
            log('Page loaded, checking for redirect result...');

            try {
                const result = await getRedirectResult(auth);
                if (result) {
                    log(`ðŸŽ‰ Redirect result received: ${result.user.email}`, 'success');
                    log(`User UID: ${result.user.uid}`);
                    log(`Display Name: ${result.user.displayName}`);

                    // Now check if profile was created
                    setTimeout(async () => {
                        const userDoc = await getDoc(doc(db, 'users', result.user.uid));
                        if (userDoc.exists()) {
                            log('âœ… User profile found after sign-in:', 'success');
                            log(JSON.stringify(userDoc.data(), null, 2));
                        } else {
                            log('âŒ No user profile found after sign-in - THIS IS THE PROBLEM!', 'error');
                        }
                    }, 1000);

                } else {
                    log('No redirect result (normal page load)');
                }
            } catch (error) {
                log(`Redirect result error: ${error.message}`, 'error');
            }
        });

        // Initial status check
        setTimeout(() => {
            const user = auth.currentUser;
            if (user) {
                updateStatus(`Signed in as: ${user.email}`, 'success');
            } else {
                updateStatus('Not signed in');
            }
        }, 1000);
    </script>
</body>

</html>