<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Approval Request</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .output {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
        }

        button {
            background: #4285f4;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }

        .error {
            color: red;
        }

        .success {
            color: green;
        }
    </style>
</head>

<body>
    <h1>Test Approval Request System</h1>

    <button onclick="runTest()">Run Approval Request Test</button>

    <div id="output" class="output">Click the button to run the test...</div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, query, where, getDocs } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDy4jBqxKpD_B6SGAqRLyTrmGxQ9rEA0zw",
            authDomain: "officeofmapp.firebaseapp.com",
            projectId: "officeofmapp",
            storageBucket: "officeofmapp.firebasestorage.app",
            messagingSenderId: "710263745328",
            appId: "1:710263745328:web:a41ed7f9f6df52970db6f5"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        function log(message, type = 'info') {
            const output = document.getElementById('output');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : '';
            output.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            output.scrollTop = output.scrollHeight;
            console.log(message);
        }

        // Simplified auth service methods for testing
        const testAuthService = {
            async requestUserCreation(email, name, role = 'staff') {
                const pendingUser = {
                    email,
                    name,
                    role,
                    requestedAt: new Date(),
                    status: 'pending',
                    authProvider: 'email'
                };

                const docRef = await addDoc(collection(db, 'pending_users'), pendingUser);
                return docRef.id;
            },

            async checkExistingPendingRequest(email) {
                const q = query(
                    collection(db, 'pending_users'),
                    where('email', '==', email),
                    where('status', '==', 'pending')
                );
                const snapshot = await getDocs(q);
                return !snapshot.empty;
            },

            async getPendingUsers() {
                const q = query(collection(db, 'pending_users'), where('status', '==', 'pending'));
                const snapshot = await getDocs(q);
                return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            }
        };

        window.runTest = async function () {
            log('=== Testing Approval Request System ===');

            try {
                // Test data
                const testEmail = `test-${Date.now()}@example.com`;
                const testName = 'Test User';
                const testRole = 'staff';

                log('1. Testing requestUserCreation...');
                log(`Test data: ${testEmail}, ${testName}, ${testRole}`);

                try {
                    const result = await testAuthService.requestUserCreation(testEmail, testName, testRole);
                    log(`✅ Request created successfully: ${result}`, 'success');
                } catch (error) {
                    log(`❌ Request creation failed: ${error.message}`, 'error');

                    if (error.message.includes('already pending')) {
                        log('ℹ️ This is expected if the request already exists');
                    }
                }

                log('2. Testing checkExistingPendingRequest...');
                try {
                    const exists = await testAuthService.checkExistingPendingRequest(testEmail);
                    log(`Pending request exists: ${exists}`);
                } catch (error) {
                    log(`❌ Check pending request failed: ${error.message}`, 'error');
                }

                log('3. Testing getPendingUsers...');
                try {
                    const pendingUsers = await testAuthService.getPendingUsers();
                    log(`Pending users count: ${pendingUsers.length}`);
                    log(`Recent pending users: ${JSON.stringify(pendingUsers.slice(0, 3), null, 2)}`);
                } catch (error) {
                    log(`❌ Get pending users failed: ${error.message}`, 'error');
                }

            } catch (error) {
                log(`❌ Test setup failed: ${error.message}`, 'error');
            }

            log('=== End Test ===');
        };
    </script>
</body>

</html>